on:
  pull_request:
    types: [opened, reopened, ready_for_review, edited, synchronize]

jobs:
  test:
    runs-on: ubuntu-latest
    name: WonderTix Docker Tests
    container: docker

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build the WonderTix containers
      id: build
      run: docker compose build
        
    - name: Bring up the WonderTix containers
      id: bring-up
      run: docker compose up database server client -d

    - name: Start WonderTix tests
      id: start-tests
      run: docker exec --env-file .env.dist wondertix-client-1 /bin/sh -c 'echo -e "Waiting 2 minutes for system to finish initializing"; sleep 120; CI=true /usr/local/bin/npm run test -- --ci'

    - name: Shutdown docker containers
      id: bring-down
      run: docker-compose down

    - name: Clean docker system
      id: clean-system
      run: docker system prune --all --force
