on:
  pull_request:
    types: [opened, reopened, ready_for_review, edited, synchronize]

jobs:
  test:
    runs-on: ubuntu-latest
    name: WonderTix Docker Tests
    container: docker

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build the WonderTix containers
      id: build
      run: docker compose build
        
    - name: Bring up the WonderTix containers
      id: bring-up
      run: docker compose up client database server -d

    - name: Sleeping for 2 minutes for system to initialize
      id: system-sleep
      run: sleep 120

    - name: Start WonderTix tests
      id: start-tests
      run: docker exec wondertix-client-1 /bin/sh -c 'CI=true npm run test'

    - name: Shutdown docker containers
      id: bring-down
      run: docker-compose down

    - name: Clean docker system
      id: clean-system
      run: docker system prune --all --force
