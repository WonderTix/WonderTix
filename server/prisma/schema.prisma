generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Account information pulled from PPH
model accounts {
  id                                    Int         @id @default(autoincrement())
  isdeleted                             Int                            @default(0)
  name                                  String?     @db.VarChar(255)
  type                                  patronType
  shippingstreet                        String?     @db.VarChar(255)
  shippingcity                          String?     @db.VarChar(255)
  shippingstate                         String?     @db.VarChar(255)
  shippingpostalcode                    String?     @db.VarChar(255)
  shippingcountry                       String?     @db.VarChar(255)
  phone                                 String?     @db.VarChar(20)
  fax                                   String?     @db.VarChar(20)
  website                               String?     @db.VarChar(255)
  createddate                           DateTime                      @default(now())
  lastmodifieddate                      DateTime
  lastmodifiedbyid                      String?     @db.VarChar(255)
  lastactivitydate                      DateTime?
  do_not_call                           Int                           @default(0)
  do_not_mail                           Int                           @default(0)
  donor_recognition                     String?     @db.VarChar(255)
  donor_email                           String?     @db.VarChar(255)
  formal_salutation                     String?     @db.VarChar(255)
  hasoptedoutofemail                    Int                           @default(0)
  informal_address_name                 String?     @db.VarChar(255)
  informal_salutation                   String?     @db.VarChar(255)
  attn                                  String?     @db.VarChar(255)
  grant_size                            String?     @db.VarChar(255)
  will_give_it                          String?     @db.VarChar(255)
  first_donation_date                   DateTime?
  last_donation_date                    DateTime?
  lifetime_donation_history_amount      Decimal   @db.Decimal(10, 2)  @default(0.0)
  lifetime_donation_number              Int                           @default(0)
  this_year_donation_history_amount     Decimal   @db.Decimal(10, 2)  @default(0.0)
  amount_donated_this_fiscal_year       Decimal   @db.Decimal(10, 2)  @default(0.0)
  last_donation_amount                  Decimal   @db.Decimal(10, 2)  @default(0.0)
  lifetimesingleticketamount            Decimal   @db.Decimal(10, 2)  @default(0.0)
  lifetimesubscriptionamount            Decimal   @db.Decimal(10, 2)  @default(0.0)
  board_member                          Int                           @default(0)
  show_sponsor                          Int                           @default(0)
  seating_accomodation                  Int                           @default(0)
  amount_donated_CY20                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  amount_donated_CY18                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  sort_name                             String?   @db.VarChar(255)
  amount_donated_last_fiscal_year       Decimal   @db.Decimal(10, 2)  @default(0.0)
  amount_donated_CY21                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  amount_donated_CY19                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  amount_donated_FY20                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  amount_donated_FY19                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  amount_donated_FY18                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  lifetime_donations_included_pledged   Decimal   @db.Decimal(10, 2)  @default(0.0)
  first_donation_date_incl_pledged      DateTime?
  amount_donated_FY21                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  firstdonationamount                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  largestdonationdate                   DateTime?
  amount_donated_FY22                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  amount_Donated_FY23                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  amount_Donated_FY24                   Decimal   @db.Decimal(10, 2)  @default(0.0)
  notes                                 notes[]
  contacts                              contacts[]
}

/// customer information
model contacts {
  id                        Int         @id @default(autoincrement())
  is_deleted                Int                                         @default(0)
  account_id                Int         @relation(fields: [account_id], references: [id])
  salutation                String?     @db.VarChar(255)
  firstname                 String?     @db.VarChar(255)
  lastname                  String?     @db.VarChar(255)
  otherstreet               String?     @db.VarChar(255)
  othercity                 String?     @db.VarChar(255)
  otherstate                String?     @db.VarChar(255)
  otherpostalcode           String?     @db.VarChar(255)
  othercountry              String?     @db.VarChar(255)
  mailingstreet             String?     @db.VarChar(255)
  mailingcity               String?     @db.VarChar(255)
  mailingstate              String?     @db.VarChar(255)
  mailingpostalcode         String?     @db.VarChar(255)
  mailingcountry            String?     @db.VarChar(255)
  phone                     String?     @db.VarChar(255)
  fax                       String?     @db.VarChar(255)
  mobilephone               String?     @db.VarChar(255)
  homephone                 String?     @db.VarChar(255)
  otherphone                String?     @db.VarChar(255)
  email                     String?     @db.VarChar(255)
  title                     String?     @db.VarChar(255)
  department                String?     @db.VarChar(255)
  birthdate                 DateTime?
  description               String?     @db.VarChar(255)
  hasoptedoutofemail        Int                           @default(0)
  hasoptedoutoffax          Int                           @default(0)
  donnotcall                Int                           @default(0)
  createddate               DateTime?                     @default(now())
  createdbyid               String?    @db.VarChar(255)
  lastmodifieddate          DateTime?
  lastmodifiedbyid          String?    @db.VarChar(255)
  systemmodstamp            DateTime?
  lastactivitydate          DateTime?
  emailbouncereason         String?    @db.VarChar(255)
  emailbouncedate           DateTime?
  pronouns                  String?    @db.VarChar(255)
  genderidentity            String?    @db.VarChar(255) 
  donate_date_entered       DateTime?
  deceased                  Int                           @default(0)
  do_not_mail               Int                           @default(0)
  donor_recognition         String?    @db.VarChar(255)
  formalsalutation          String?    @db.VarChar(255)
  informal_address_name     String?    @db.VarChar(255)
  informal_salutation       String?    @db.VarChar(255)
  volunteer_interests       String?    @db.VarChar(255)
  other_email               String?    @db.VarChar(255)
  company                   String?    @db.VarChar(255)
  middlename                String?    @db.VarChar(255)
  suffix                    String?    @db.VarChar(255)
  contactorigin             String?    @db.VarChar(255)
  emailstatus               emailStatus
  current_season_subscriber Decimal?   @db.Decimal(10, 2)  @default(0.0) 
  email_lists               String?    @db.VarChar(255)
  board_member              Decimal?   @db.Decimal(10, 2)  @default(0.0)
  seating_accomodation      Decimal?   @db.Decimal(10, 2)  @default(0.0)
  reserved_seating          Decimal?   @db.Decimal(10, 2)  @default(0.0)
  attending_next_dinner     Decimal?   @db.Decimal(10, 2)  @default(0.0)
  chocolate_and_card        Decimal?   @db.Decimal(10, 2)  @default(0.0)
  legacy_membership_circle  Decimal?   @db.Decimal(10, 2)  @default(0.0) 
  email_list_notes          String?    @db.VarChar(255)
  account                   accounts   @relation(fields: [account_id], references: [id])
  donations                 donations[]
  orders                    orders[]
}

/// date is used to store information about specific dates to simplify queries
model date {
  dateid                              Int              @id
  date_actual                         DateTime         @db.Date
  day_name                            String           @db.VarChar(9)
  day_of_week                         Int
  day_of_month                        Int
  day_of_quarter                      Int
  day_of_year                         Int
  week_of_month                       Int
  week_of_year                        Int
  month_actual                        Int
  month_name                          String           @db.VarChar(9)
  quarter                             Int
  year_actual                         Int
  first_day_of_week                   DateTime         @db.Date
  last_day_of_week                    DateTime         @db.Date
  first_day_of_month                  DateTime         @db.Date
  last_day_of_month                   DateTime         @db.Date
  first_day_of_quarter                DateTime         @db.Date
  last_day_of_quarter                 DateTime         @db.Date
  first_day_of_year                   DateTime         @db.Date
  last_day_of_year                    DateTime         @db.Date
  weekend                             Boolean
  discounts_discounts_enddateTodate   discounts[]      @relation("discounts_enddateTodate")
  discounts_discounts_startdateTodate discounts[]      @relation("discounts_startdateTodate")
  donations                           donations[]
  eventinstances                      eventinstances[]
  orders                              orders[]
  seasons_seasons_enddateTodate       seasons[]        @relation("seasons_enddateTodate")
  seasons_seasons_startdateTodate     seasons[]        @relation("seasons_startdateTodate")
  task_task_dateassignedTodate        task[]           @relation("task_dateassignedTodate")
  task_task_datecreatedTodate         task[]           @relation("task_datecreatedTodate")
  task_task_datedueTodate             task[]           @relation("task_datedueTodate")
}

/// discounts are applied to orders and may be limited to specific ticket types, event and/or dates
/// amount is a fixed amount discount, percent is a percentage discount
/// discounts with a percent and amount value will use the percent value capped at the amount value
model discounts {
  discountid                     Int         @id @default(autoincrement())
  code                           String?     @db.VarChar(32)
  amount                         Int?
  percent                        Int?
  startdate                      Int?
  enddate                        Int?
  tickettypeid_fk                Int?
  createdby_fk                   Int?
  usagelimit                     Int?
  min_tickets                    Int?
  min_events                     Int?
  users                          users?      @relation(fields: [createdby_fk], references: [userid], onDelete: NoAction, onUpdate: NoAction)
  date_discounts_enddateTodate   date?       @relation("discounts_enddateTodate", fields: [enddate], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
  date_discounts_startdateTodate date?       @relation("discounts_startdateTodate", fields: [startdate], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
  tickettype                     tickettype? @relation(fields: [tickettypeid_fk], references: [tickettypeid], onDelete: NoAction, onUpdate: NoAction)
  orders                         orders[]
}

/// customer or anonymous donations
/// donations can be one time or recurring, stored in the frequency field
/// payment_intent and refund_intent are stripe payment intent ids
model donations {
  donationid     Int       @id @default(autoincrement())
  contactid_fk   Int?
  isanonymous    Boolean?  @default(false)
  amount         Decimal?  @db.Money
  donorname      String?   @db.VarChar(255)
  frequency      freq?
  comments       String?   @db.VarChar(255)
  payment_intent String?   @db.VarChar(255)
  refund_intent  String?   @db.VarChar(255)
  donationdate   Int?
  date           date?     @relation(fields: [donationdate], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
  contacts       contacts? @relation(fields: [contactid_fk], references: [contactid], onDelete: NoAction, onUpdate: NoAction, map: "donations_donoid_fkey")
}

/// an event instance is a specific showing of an event
/// tickets are sold for event instances only if the salesstatus is true and the event date is in the future
/// preview events are are pre showings of an event before the event is open to the public
model eventinstances {
  eventinstanceid    Int                  @id @default(autoincrement())
  eventid_fk         Int
  eventdate          Int
  eventtime          DateTime             @db.Timetz(6)
  salestatus         Boolean?
  totalseats         Int?
  availableseats     Int?
  purchaseuri        String?              @db.VarChar(255)
  ispreview          Boolean?             @default(false)
  defaulttickettype  Int?
  tickettype         tickettype?          @relation(fields: [defaulttickettype], references: [tickettypeid], onDelete: NoAction, onUpdate: NoAction)
  date               date                 @relation(fields: [eventdate], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
  events             events               @relation(fields: [eventid_fk], references: [eventid], onDelete: NoAction, onUpdate: NoAction, map: "eventinstances_eventid_fkey")
  eventtickets       eventtickets[]
  ticketrestrictions ticketrestrictions[]
}

/// an event is a performance, a class, a workshop, etc.
/// the showings of an event are eventinstances
model events {
  eventid              Int              @id @default(autoincrement())
  seasonid_fk          Int?
  eventname            String           @db.VarChar(255)
  eventdescription     String?          @db.VarChar(255)
  active               Boolean?
  seasonticketeligible Boolean?
  imageurl             String?          @db.VarChar(255)
  eventinstances       eventinstances[]
  seasons              seasons?          @relation(fields: [seasonid_fk], references: [seasonid], onDelete: SetNull, onUpdate: Cascade, map: "events_seasonid_fkey")
  seasontickets        seasontickets[]
}

/// event tickets is a ticket that can be purchased for an event instance
/// a ticket is redeemed when it is used to enter an event instance
/// tickets can be donated back to wondertix or refunded
model eventtickets {
  eventticketid      Int             @id(map: "tickets_pkey") @default(autoincrement())
  eventinstanceid_fk Int
  tickettypeid_fk    Int?
  singleticket_fk    Int?
  redeemed           Boolean?        @default(false)
  redeemed_ts        DateTime?       @db.Timetz(6)
  donated            Boolean?        @default(false)
  tickettype         tickettype?     @relation(fields: [tickettypeid_fk], references: [tickettypeid], onDelete: NoAction, onUpdate: NoAction)
  eventinstances     eventinstances  @relation(fields: [eventinstanceid_fk], references: [eventinstanceid], onDelete: NoAction, onUpdate: NoAction, map: "tickets_eventinstanceid_fkey")
  singleticket       singletickets?  @relation(fields: [singleticket_fk], references: [singleticketid], onDelete: SetNull, onUpdate: NoAction)
  seasontickets      seasontickets[]
}

// Note table taken from PPH:
model notes {
  id                Int       @id @default(autoincrement())
  isdeleted         Int       @default(0)
  contactid         Int?
  accountid         Int       @relation(fields: [accountid], references: [id])
  title             String    @db.VarChar(255)
  body              String    @db.VarChar(255)
  createddate       DateTime  @default(now())
  lastmodifieddate  DateTime
  account           accounts  @relation(fields: [accountid], references: [id])
}


/// a line item in a customers order
/// the price is the price of the item at the time of purchase before any discounts are applied
model orderitems {
  orderitemid   Int             @id @default(autoincrement())
  orderid_fk    Int
  price         Decimal?        @db.Money
  orders        orders          @relation(fields: [orderid_fk], references: [orderid], onDelete: Cascade, onUpdate: NoAction, map: "orderitems_orderid_fkey")
  seasontickets seasontickets[]
  singletickets singletickets[]
}

/// a customers order
/// refund and payment intents are the uuids from stripe when a refund or payment is made
model orders {
  orderid           Int          @id @default(autoincrement())
  contactid_fk      Int
  orderdate         Int
  ordertime         DateTime?    @db.Timetz(6)
  discountid_fk     Int?
  payment_intent    String?      @db.VarChar(255)
  checkout_sessions String?      @db.VarChar(255)
  refund_intent     String?      @db.VarChar(255)
  ordertotal        Decimal?     @db.Money
  orderitems        orderitems[]
  contacts          contacts     @relation(fields: [contactid_fk], references: [contactid], onDelete: NoAction, onUpdate: NoAction, map: "orders_contactid_fkey")
  discounts         discounts?   @relation(fields: [discountid_fk], references: [discountid], onDelete: NoAction, onUpdate: NoAction, map: "orders_discountid_fkey")
  date              date         @relation(fields: [orderdate], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
}

/// provides a way to store reports
model savedreports {
  savedreportid Int     @id @default(autoincrement())
  tablename     String? @db.VarChar(255)
  queryattr     String?
}

/// a season is a collection of events over a period of time (e.g. a summer season)
model seasons {
  seasonid                     Int      @id @default(autoincrement())
  name                         String   @db.VarChar(100)
  startdate                    Int
  enddate                      Int
  imageurl                     String?  @db.VarChar(255)
  events                       events[]
  date_seasons_enddateTodate   date     @relation("seasons_enddateTodate", fields: [enddate], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
  date_seasons_startdateTodate date     @relation("seasons_startdateTodate", fields: [startdate], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
}

/// a season ticket is a ticket that is not part of a bulk package of tickets during a season
/// season tickets may be sold before the event is scheduled so the eventid_fk is nullable
/// tickets can be swapped for another event ticket
/// when swapped the old season ticket is marked and the old event ticket is marked as not purcahsed
/// a new season ticket is created for the new event ticket and the orderitem is updated to point to the new season ticket
model seasontickets {
  seasonticketid        Int              @id @default(autoincrement())
  orderitemid_fk        Int
  eventticketid_fk      Int?
  eventid_fk            Int
  seasontickettypeid_fk Int
  ticketwasswapped      Boolean?         @default(false)
  events                events           @relation(fields: [eventid_fk], references: [eventid], onDelete: NoAction, onUpdate: NoAction)
  eventtickets          eventtickets?    @relation(fields: [eventticketid_fk], references: [eventticketid], onDelete: NoAction, onUpdate: NoAction)
  orderitems            orderitems       @relation(fields: [orderitemid_fk], references: [orderitemid], onDelete: NoAction, onUpdate: NoAction)
  seasontickettype      seasontickettype @relation(fields: [seasontickettypeid_fk], references: [seasontickettypeid], onDelete: NoAction, onUpdate: NoAction)
}

/// ticket types for season tickets
model seasontickettype {
  seasontickettypeid Int             @id @default(autoincrement())
  description        String          @db.VarChar(100)
  price              Decimal         @db.Money
  seasontickets      seasontickets[]
}

/// a single ticket is a purchased event instance ticket
/// a single ticket can be swapped for another event instance ticket
/// when swapped, the original single ticket is marked as swapped,
/// the old event ticket is marked as not purchased and a new single ticket is created with the old order item id and new event ticket id
model singletickets {
  singleticketid   Int            @id @default(autoincrement())
  orderitemid_fk   Int
  ticketwasswapped Boolean?       @default(false)
  eventtickets     eventtickets[]
  orderitems       orderitems     @relation(fields: [orderitemid_fk], references: [orderitemid], onDelete: Cascade, onUpdate: NoAction)
}

/// used to create and assign tasks such as a todo-list, memo, investigate and issue, etc.
/// task may relate to a contact, donation, order, user, or other task
model task {
  taskid                        Int         @id @default(autoincrement())
  parentid_fk                   Int?
  assignto_fk                   Int?
  reportto_fk                   Int?
  subject                       String?     @db.VarChar(255)
  description                   String?     @db.VarChar(255)
  status                        state?
  datecreated                   Int?
  dateassigned                  Int?
  datedue                       Int?
  ref_contact                   Int?
  ref_donation                  Int?
  ref_order                     Int?
  ref_user                      Int?
  users_task_assignto_fkTousers users?      @relation("task_assignto_fkTousers", fields: [assignto_fk], references: [userid], onDelete: NoAction, onUpdate: NoAction, map: "task_assign_to_fkey")
  date_task_dateassignedTodate  date?       @relation("task_dateassignedTodate", fields: [dateassigned], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
  date_task_datecreatedTodate   date?       @relation("task_datecreatedTodate", fields: [datecreated], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
  date_task_datedueTodate       date?       @relation("task_datedueTodate", fields: [datedue], references: [dateid], onDelete: NoAction, onUpdate: NoAction)
  task                          task?       @relation("taskTotask", fields: [parentid_fk], references: [taskid], onDelete: NoAction, onUpdate: NoAction, map: "task_parent_id_fkey")
  other_task                    task[]      @relation("taskTotask")
  users_task_reportto_fkTousers users?      @relation("task_reportto_fkTousers", fields: [reportto_fk], references: [userid], onDelete: NoAction, onUpdate: NoAction)
  tasknotes                     tasknotes[]
}

/// contains additional notes for a task that can not fit in the description field
model tasknotes {
  tasknoteid Int     @id @default(autoincrement())
  taskid_fk  Int?
  date       Int?
  notes      String?
  task       task?   @relation(fields: [taskid_fk], references: [taskid], onDelete: NoAction, onUpdate: NoAction)
}

/// ticket restrictions for an event are used to limit the number of tickets that can be sold for a ticket type for an event instance
model ticketrestrictions {
  ticketrestrictionsid Int            @id @default(autoincrement())
  eventinstanceid_fk   Int
  tickettypeid_fk      Int
  ticketlimit          Int
  ticketssold          Int?           @default(0)
  eventinstances       eventinstances @relation(fields: [eventinstanceid_fk], references: [eventinstanceid], onDelete: NoAction, onUpdate: NoAction)
  tickettype           tickettype     @relation(fields: [tickettypeid_fk], references: [tickettypeid], onDelete: NoAction, onUpdate: NoAction)
}

/// types of tickets that can be assigned to an event
model tickettype {
  tickettypeid       Int                  @id @default(autoincrement())
  description        String               @db.VarChar(100)
  price              Decimal              @db.Money
  concessions        Decimal              @db.Money
  deprecated         Boolean?             @default(false)
  discounts          discounts[]
  eventinstances     eventinstances[]
  eventtickets       eventtickets[]
  ticketrestrictions ticketrestrictions[]
}

/// users have access to the admin area to manage events, tickets, etc
/// only users with the is_superadmin flag can access the reports
model users {
  userid                       Int         @id @default(autoincrement())
  username                     String      @db.VarChar(255)
  is_superadmin                Boolean     @default(false)
  auth0_id                     String?     @db.VarChar(255)
  discounts                    discounts[]
  task_task_assignto_fkTousers task[]      @relation("task_assignto_fkTousers")
  task_task_reportto_fkTousers task[]      @relation("task_reportto_fkTousers")
}

enum freq {
  one_time @map("one-time")
  weekly
  monthly
  yearly
}

enum state {
  not_started
  in_progress
  completed
}

model StripeWebhook {
  id        Int     @id @default(autoincrement())
  eventid   String
  event     String
  livemode  Boolean
  created   Int
  data      String
  object    String
  requestid String
  type      String
}

model Error {
  id        Int    @id @default(autoincrement())
  message   String
  stack     String
  createdAt Int
}

enum patronType {
  Business
  Corporate Foundation
  Corporation
  Federal Agency
  Foundation
  Household
  Individual
  Local Agency
  Nonprofit: Arts
  Nonprofit: Community Development
  Nonprofit: Education
  Nonprofit: Environment
  Nonprofit: Health Services
  Nonprofit: Human Services
  Nonprofit: Public Policy
  Private Foundation
  School
  State Agency
  Business
  FederalAgency
  Foundation
  Household
  Individual
  LocalAgency
  NonProfit
  School
  StateAgency
  Corporation
  Partnership
  SoleProprietorship
  Trust
  Estate
  ReligiousInstitution
  University
  Hospital
  Library
  TradeAssociation
  InternationalOrganization
  CommunityGroup
  Club
  Cooperative
  GovernmentBody
  ResearchInstitution
  TradeUnion
  ProfessionalAssociation
  PoliticalParty
  Charity
  PublicInstitution
  Military
  NewsMedia
  EntertainmentIndustry
  StartUp
  MultinationalCorporation
  SmallMediumEnterprise
  MicroEnterprise
  ThinkTank
  CulturalInstitution
  SportsOrganization
}


enum emailStatus {
  Opt-Out
  Bounced
  Collected
  Confirmed Opt-In
}